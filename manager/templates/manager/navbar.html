{% load static %}

<nav class="w-full p-4 bg-[#27693d] text-white flex items-center justify-between shadow-md z-20 relative flex-shrink-0">
    <div class="flex items-center space-x-4">
        <img src="{% static 'images/logo.png' %}" alt="Logo" class="h-16 w-auto ml-4 md:ml-10 transition hover:scale-105">
    </div>

    <div class="flex items-center space-x-4 md:space-x-6 mr-4 md:mr-10">
        
        <div class="relative" x-data="{ open: false }">
            <button onclick="toggleNotif()" class="relative p-2 text-white hover:bg-white/20 rounded-full focus:outline-none transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <span id="notif-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-white transform translate-x-1/4 -translate-y-1/4 bg-red-600 rounded-full border-2 border-[#27693d] animate-pulse {% if unread_notifications_count == 0 %}hidden{% endif %}">
                    {{ unread_notifications_count }}
                </span>
            </button>

            <div id="notifDropdown" class="hidden absolute right-0 mt-3 w-80 bg-white rounded-xl shadow-xl overflow-hidden z-50 border border-gray-100 origin-top-right text-gray-800 ring-1 ring-black ring-opacity-5">
                <div class="py-3 px-4 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-700">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                    <span id="notif-count-label" class="text-xs text-red-500 font-medium bg-red-50 px-2 py-0.5 rounded-full {% if unread_notifications_count == 0 %}hidden{% endif %}">
                        {{ unread_notifications_count }} ‡πÉ‡∏´‡∏°‡πà
                    </span>
                </div>
                
                <div id="notif-list" class="max-h-64 overflow-y-auto custom-scrollbar">
                    </div>
                
                <div id="notif-footer" 
                     class="bg-gray-50 px-4 py-2 border-t border-gray-100 text-center cursor-pointer hover:bg-gray-100 transition hidden"
                     onclick="expandNotifications()">
                    <span class="text-xs text-[#27693d] font-medium hover:underline">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                </div>
            </div>
        </div>

        {% if request.user.is_authenticated %}
        <div class="flex items-center gap-3 pl-4 border-l border-[#5da35d] ml-2">
            <div class="text-right hidden md:block">
                <p class="text-sm font-bold leading-tight">{{ request.user.get_full_name|default:request.user.username }}</p>
                <p class="text-xs text-green-200 font-medium">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</p>
            </div>
            <div class="relative group cursor-pointer">
                <img src="https://api.dicebear.com/7.x/adventurer/svg?seed={{ request.user.username }}&backgroundColor=b6e3f4" alt="User Avatar" class="h-10 w-10 rounded-full border-2 border-white bg-white shadow-sm">
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
            </div>
        </div>
        {% endif %}
    </div>
</nav>

<script>
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    let isExpanded = false;

    function toggleNotif() {
        const dropdown = document.getElementById('notifDropdown');
        if (dropdown) dropdown.classList.toggle('hidden');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
    function expandNotifications() {
        isExpanded = true; // ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ
        updateNotifications(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    }

    window.addEventListener('click', function(e) {
        const btn = document.querySelector('button[onclick="toggleNotif()"]');
        const dropdown = document.getElementById('notifDropdown');
        if (btn && dropdown && !btn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });

    // üöÄ MAIN SCRIPT
    function updateNotifications() {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á parameter all=true ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        let url = "{% url 'survey:check_notifications' %}?t=" + new Date().getTime();
        if (isExpanded) {
            url += "&all=true";
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('notif-badge');
                const countLabel = document.getElementById('notif-count-label');
                const listContainer = document.getElementById('notif-list');
                const footer = document.getElementById('notif-footer');

                // 1. Update Badge
                if (data.unread_count > 0) {
                    if(badge) { badge.classList.remove('hidden'); badge.innerText = data.unread_count; }
                    if(countLabel) { countLabel.classList.remove('hidden'); countLabel.innerText = data.unread_count + ' ‡πÉ‡∏´‡∏°‡πà'; }
                } else {
                    if(badge) badge.classList.add('hidden');
                    if(countLabel) countLabel.innerText = '';
                }

                // 2. Update Footer Visibility
                // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏≤‡∏¢ AND ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                if (footer) {
                    if (!isExpanded && data.has_more) {
                        footer.classList.remove('hidden');
                    } else {
                        footer.classList.add('hidden');
                    }
                }

                // 3. Render List
                if (listContainer) {
                    if (data.notifications && data.notifications.length > 0) {
                        let html = '';
                        data.notifications.forEach(function(notif) {
                            let dotClass = notif.is_read ? 'hidden' : 'animate-pulse';
                            let bgClass = notif.is_read ? 'bg-white' : 'bg-green-50'; // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô (Option)
                            
                            html += '<a href="' + notif.read_url + '" class="block px-4 py-3 hover:bg-gray-50 border-b border-gray-100 transition duration-150 group ' + bgClass + '">';
                            html += '<div class="flex items-start">';
                            html += '<div class="flex-shrink-0 pt-1"><div class="w-2 h-2 bg-red-500 rounded-full ' + dotClass + '"></div></div>';
                            html += '<div class="ml-3 w-0 flex-1">';
                            html += '<p class="text-sm font-semibold text-gray-900 group-hover:text-[#27693d] transition-colors">' + notif.title + '</p>';
                            html += '<p class="text-xs text-gray-500 mt-0.5 line-clamp-2">' + notif.message + '</p>';
                            html += '<p class="text-[10px] text-gray-400 mt-1 flex items-center gap-1">';
                            html += '<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                            html += notif.time_ago;
                            html += '</p></div></div></a>';
                        });
                        listContainer.innerHTML = html;
                    } else {
                        listContainer.innerHTML = '<div class="px-4 py-12 text-center text-gray-400 text-sm flex flex-col items-center justify-center">' +
                            '<svg class="w-10 h-10 mb-2 text-gray-300 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>' +
                            '<span class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</span></div>';
                    }
                }
            })
            .catch(error => console.error('Error:', error));
    }

    updateNotifications();
    setInterval(updateNotifications, 3000);
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 2px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
</style>