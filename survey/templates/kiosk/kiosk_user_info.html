{% extends 'kiosk/base_kiosk.html' %} 
{% load static i18n %}
{% load static %}
{% block title %}ยินดีต้อนรับ - {{ service_point.name }}{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{trans"ข้อมูลผู้รับบริการ -"} {{ service_point.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        /* ... (CSS เดิม) ... */
        .header { width: 100%; padding: 10px 30px 10px 0; display: flex; align-items: center; background-color: #006837; color: white; box-sizing: border-box; position: absolute; top: 0; left: 0; z-index: 50; }
        .header-content { display: flex; align-items: center; }
        .header-logo { height: 80px; width: auto; margin-left: 40px; margin-right: 15px; object-fit: contain; }
        .settings-container { position: relative; margin-left: auto; }
        .settings-icon { cursor: pointer; }
        .settings-icon svg { height: 30px; width: 30px; fill: white; display: block; }
        .login-dropdown { display: none; position: absolute; top: 100%; right: 0; margin-top: 10px; background-color: white; color: #006837; padding: 10px 20px; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); text-decoration: none; font-weight: bold; }
        .login-dropdown.show { display: block; }
        .radio-card:checked + div { background-color: #f0fdf4; border-color: #16a34a; color: #15803d; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .hover-trigger:hover { border-color: #86efac; background-color: #f9fafb; }
        .border-red-500 { border-color: #ef4444 !important; }
        .text-red-500 { color: #ef4444 !important; }
        .error-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 max-w-3xl">
        
        <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
            <div class="p-6 border-b border-gray-100 bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-green-100 text-green-600 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </span>
                    {% trans "ข้อมูลผู้รับบริการ" %}
                </h2>
                <p class="text-gray-500 text-sm mt-2 ml-12">{% trans "กรุณาเลือกข้อมูลที่ตรงกับตัวท่าน (จำเป็นทุกข้อ)" %}</p>
            </div>

            <form method="POST" id="userInfoForm" class="p-6 space-y-8" novalidate>
                {% csrf_token %}

                <!-- 1. ท่านคือ -->
                <div class="form-group transition-all duration-300" id="group-role">
                    <label class="block text-gray-800 font-semibold mb-3 text-lg label-title">{% trans "1. ท่านคือ" %} <span class="text-red-500">*</span></label>
                    <div class="grid grid-cols-2 gap-4 options-container p-1 rounded-xl border border-transparent">
                        <label class="cursor-pointer group">
                            <!-- [แก้ไข] เพิ่ม Logic เช็คค่าเดิม -->
                            <input type="radio" name="user_role" value="ผู้ป่วย" class="radio-card hidden" required 
                                   {% if request.session.patient_info.user_role == "ผู้ป่วย" %}checked{% endif %}>
                            <div class="border-2 border-gray-200 rounded-xl p-4 text-center hover-trigger transition duration-200 ease-in-out h-full flex items-center justify-center flex-col gap-2 card-content">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400 group-hover:text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <span class="text-lg font-medium">{% trans "ผู้ป่วย" %}</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="user_role" value="ญาติ/ผู้ติดตาม" class="radio-card hidden" required
                                   {% if request.session.patient_info.user_role == "ญาติ/ผู้ติดตาม" %}checked{% endif %}>
                            <div class="border-2 border-gray-200 rounded-xl p-4 text-center hover-trigger transition duration-200 ease-in-out h-full flex items-center justify-center flex-col gap-2 card-content">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400 group-hover:text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                <span class="text-lg font-medium">{% trans "ญาติ / ผู้ติดตาม" %}</span>
                            </div>
                        </label>
                    </div>
                    <p class="text-red-500 text-sm mt-2 hidden error-msg font-bold flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        {% trans "กรุณาเลือกสถานะของท่าน" %}
                    </p>
                </div>

                <!-- 2. เพศ -->
                <div class="form-group transition-all duration-300" id="group-gender">
                    <label class="block text-gray-800 font-semibold mb-3 text-lg label-title">{% trans "2. เพศ" %} <span class="text-red-500">*</span></label>
                    <div class="grid grid-cols-3 gap-3 options-container p-1 rounded-xl border border-transparent">
                        <label class="cursor-pointer">
                            <input type="radio" name="patient_gender" value="ชาย" class="radio-card hidden" required
                                   {% if request.session.patient_info.gender == "ชาย" %}checked{% endif %}>
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center hover-trigger transition card-content">
                                <span class="block font-medium">{% trans "ชาย" %}</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="patient_gender" value="หญิง" class="radio-card hidden" required
                                   {% if request.session.patient_info.gender == "หญิง" %}checked{% endif %}>
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center hover-trigger transition card-content">
                                <span class="block font-medium">{% trans "หญิง" %}</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="patient_gender" value="ไม่ระบุ" class="radio-card hidden" required
                                   {% if request.session.patient_info.gender == "ไม่ระบุ" %}checked{% endif %}>
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center hover-trigger transition card-content">
                                <span class="block font-medium text-gray-500">{% trans "ไม่ระบุ" %}</span>
                            </div>
                        </label>
                    </div>
                    <p class="text-red-500 text-sm mt-2 hidden error-msg font-bold flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        {% trans "กรุณาเลือกเพศ" %}
                    </p>
                </div>

                <!-- 3. ช่วงอายุ -->
                <div class="form-group transition-all duration-300" id="group-age">
                    <label class="block text-gray-800 font-semibold mb-3 text-lg label-title">
                        {% trans "3. ช่วงอายุ" %} <span class="text-red-500">*</span>
                    </label>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 options-container p-1 rounded-xl border border-transparent">
                        
                        {% for value, label in age_ranges %}
                        
                        <label class="cursor-pointer">
                            <input type="radio" name="age_range" value="{{ value }}" class="radio-card hidden" required
                                {% if request.session.patient_info.age_range == value %}checked{% endif %}>
                            
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center hover-trigger transition h-full flex items-center justify-center card-content">
                                <span class="text-sm font-medium">{{ label }}</span>
                            </div>
                        </label>
                        
                        {% endfor %}
                        
                    </div>
                    
                    <p class="text-red-500 text-sm mt-2 hidden error-msg font-bold flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        {% trans "กรุณาเลือกช่วงอายุ" %}
                    </p>
                </div>

                <!-- 4. สิทธิการรักษา -->
                <div class="form-group transition-all duration-300" id="group-benefit">
                    <label class="block text-gray-800 font-semibold mb-3 text-lg label-title">{% trans "4. สิทธิการรักษา" %} <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <select name="benefit_plan" id="benefit_plan" class="w-full p-4 pl-5 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white appearance-none text-lg text-gray-700 cursor-pointer transition-colors duration-200" required>
                            <option value="" disabled {% if not request.session.patient_info.benefit_plan %}selected{% endif %} class="text-gray-400">{% trans "-- กรุณาเลือกสิทธิการรักษา --" %}</option>
                            
                            <option value="บัตรทอง (UC)" {% if request.session.patient_info.benefit_plan == "บัตรทอง (UC)" %}selected{% endif %}>{% trans "บัตรทอง (UC)" %}</option>
                            <option value="ประกันสังคม" {% if request.session.patient_info.benefit_plan == "ประกันสังคม" %}selected{% endif %}>{% trans "ประกันสังคม" %}</option>
                            <option value="ข้าราชการ/รัฐวิสาหกิจ" {% if request.session.patient_info.benefit_plan == "ข้าราชการ/รัฐวิสาหกิจ" %}selected{% endif %}>{% trans "ข้าราชการ / รัฐวิสาหกิจ" %}</option>
                            <option value="ชำระเงินเอง" {% if request.session.patient_info.benefit_plan == "ชำระเงินเอง" %}selected{% endif %}>{% trans "ชำระเงินเอง" %}</option>
                            <option value="อื่นๆ" {% if request.session.patient_info.benefit_plan == "อื่นๆ" %}selected{% endif %}>{% trans "อื่นๆ" %}</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                            <svg class="fill-current h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>
                    <p class="text-red-500 text-sm mt-2 hidden error-msg font-bold flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        {% trans "กรุณาเลือกสิทธิการรักษา" %}
                    </p>
                </div>

                <!-- Actions -->
                <div class="pt-8 flex justify-between items-center border-t border-gray-100 mt-8">
                    <a href="{% url 'survey:kiosk_welcome' service_point.id %}" class="text-gray-500 hover:text-gray-800 font-medium px-6 py-3 rounded-lg hover:bg-gray-100 transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        {% trans "ย้อนกลับ" %}
                    </a>
                    <button type="submit" id="submitBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-10 rounded-full shadow-lg transform transition hover:scale-105 hover:shadow-xl flex items-center gap-3 text-lg">
                        {% trans "ถัดไป" %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

            </form>
        </div>
    </main>

    <script>
        // Header Script
        const settingsToggle = document.getElementById('settings-toggle');
        const loginDropdown = document.getElementById('login-dropdown');
        
        if (settingsToggle) {
            settingsToggle.addEventListener('click', function(event) {
                event.preventDefault(); 
                loginDropdown.classList.toggle('show');
            });
            window.addEventListener('click', function(event) {
                if (!settingsToggle.contains(event.target)) {
                    if (loginDropdown.classList.contains('show')) {
                        loginDropdown.classList.remove('show');
                    }
                }
            });
        }

        // Validation Script
        const form = document.getElementById('userInfoForm');
        
        form.addEventListener('submit', function(event) {
            let isValid = true;
            let firstInvalidElement = null;
            
            const showError = (groupDiv, isError) => {
                const errorMsg = groupDiv.querySelector('.error-msg');
                const labelTitle = groupDiv.querySelector('.label-title');
                const optionsContainer = groupDiv.querySelector('.options-container');
                
                if (isError) {
                    errorMsg.classList.remove('hidden');
                    errorMsg.classList.add('error-shake');
                    if (optionsContainer) optionsContainer.classList.add('border-red-500', 'bg-red-50');
                    if (labelTitle) labelTitle.classList.add('text-red-600');
                    
                    setTimeout(() => {
                        errorMsg.classList.remove('error-shake');
                    }, 500);
                } else {
                    errorMsg.classList.add('hidden');
                    if (optionsContainer) optionsContainer.classList.remove('border-red-500', 'bg-red-50');
                    if (labelTitle) labelTitle.classList.remove('text-red-600');
                }
            };

            ['user_role', 'patient_gender', 'age_range'].forEach(name => {
                const radios = document.getElementsByName(name);
                const groupDiv = document.getElementById('group-' + (name === 'user_role' ? 'role' : (name === 'patient_gender' ? 'gender' : 'age')));
                
                let isChecked = false;
                for (const r of radios) {
                    if (r.checked) isChecked = true;
                }

                if (!isChecked) {
                    isValid = false;
                    showError(groupDiv, true);
                    if (!firstInvalidElement) firstInvalidElement = groupDiv;
                } else {
                    showError(groupDiv, false);
                }
                
                radios.forEach(radio => {
                    radio.addEventListener('change', () => showError(groupDiv, false));
                });
            });

            const benefitSelect = document.getElementById('benefit_plan');
            const benefitGroup = document.getElementById('group-benefit');
            
            const showSelectError = (isError) => {
                const errorMsg = benefitGroup.querySelector('.error-msg');
                const labelTitle = benefitGroup.querySelector('.label-title');
                if (isError) {
                    errorMsg.classList.remove('hidden');
                    errorMsg.classList.add('error-shake');
                    benefitSelect.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                    if (labelTitle) labelTitle.classList.add('text-red-600');
                    setTimeout(() => errorMsg.classList.remove('error-shake'), 500);
                } else {
                    errorMsg.classList.add('hidden');
                    benefitSelect.classList.remove('border-red-500', 'bg-red-50', 'text-red-700');
                    if (labelTitle) labelTitle.classList.remove('text-red-600');
                }
            }

            if (benefitSelect.value === "") {
                isValid = false;
                showSelectError(true);
                if (!firstInvalidElement) firstInvalidElement = benefitGroup;
            } else {
                showSelectError(false);
            }
            
            benefitSelect.addEventListener('change', () => showSelectError(false));

            if (!isValid) {
                event.preventDefault(); 
                if (firstInvalidElement) {
                    firstInvalidElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    </script>
</body>
</html>

{% endblock %}